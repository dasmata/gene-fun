<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="src/Vector.js" type="text/javascript" ></script>
    <script src="src/Agent.js" type="text/javascript" ></script>
    <script src="src/Genes.js" type="text/javascript" ></script>
    <script src="src/Population.js" type="text/javascript" ></script>
    <script src="src/World.js" type="text/javascript" ></script>
    <script src="src/Brain.js" type="text/javascript" ></script>
    <script src="src/renderers/WorldRenderer.js" type="text/javascript" ></script>
    <script src="src/renderers/AgentRenderer.js" type="text/javascript" ></script>
    <script src="src/renderers/WallRenderer.js" type="text/javascript" ></script>
    <script src="src/renderers/AreaRenderer.js" type="text/javascript" ></script>
    <script src="src/neurons/GenericNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/seeLeftNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/seeRightNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/seeUpNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/seeDownNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/moveRandNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/moveLeftNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/moveRightNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/moveUpNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/moveDownNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/processingNegateNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/processingVoidNeuron.js" type="text/javascript" ></script>
    <script src="src/neurons/neuronPool.js" type="text/javascript" ></script>
    <style>
        main {
            display: flex;
            align-items: flex-start;
        }
        .world {
            width: calc(256px * (2 + 2));
            border: 1px solid black;
            z-index: 1;
            position: absolute;
        }
        .breeding-area{
            width: calc(256px * (2 + 2));
            border: 1px solid black;
            z-index: 0;
            position: absolute;
        }
        #canvas-wrapper {
            width: calc(256px * (2 + 2));
            position: relative;
        }
        #controls {
            width: calc(256px * (2 + 2));
            padding-left: 5px;
        }
    </style>
</head>
<body>
<main>
    <section id="canvas-wrapper"></section>
    <section id="controls">
        <span>Gen <span id="gen">0</span></span>
        <button id="killSw">Kill everyone!!</button>
        <button id="start">create</button>
        <button id="play">play</button>
        <button id="pause">pause</button>
    </section>
</main>
<template id="agent">
    <div>
        <section id="details-container">
            <h2></h2>
            <div class="brain"></div>
            <div class="genome"></div>
            <button>run</button>
        </section>
    </div>
</template>
<template id="neuron">
    <div>
        <div id="neuron-container">
        </div>
    </div>
</template>

<script>
    let currentDetails = null
    renderAgentDetails = (agent) => {
        if (currentDetails) {
            document.getElementById('controls').removeChild(currentDetails);
        }
        const tree = document.getElementById('agent').content.cloneNode(true)
        tree.querySelector('h2').textContent = Symbol.keyFor(agent.id)
        tree.querySelector('button').addEventListener('click', () => {
            console.log(agent.visualizeNeurons())
        })
        const ntpl = document.getElementById('neuron');
        const brain = tree.querySelector('.brain');
        agent.brain.forEach(conn => {
            const ntree = ntpl.content.cloneNode(true);
            const node = ntree.querySelector('#neuron-container');
            node.textContent = Symbol.keyFor(conn[0]);
            brain.appendChild(node);
        })
        currentDetails = tree.querySelector('#details-container');
        document.getElementById('controls').appendChild(currentDetails);
    }
    const clickObserver = (e) => {
        if (e.type != 'click') {
            return
        }
        renderAgentDetails(e.payload)
    }

    const size = {
        width: 256,
        height: 256
    };

    const getWalls = () => [
        [new Vector([60,30], Object.values(size)), new Vector([69,120], Object.values(size))],
        [new Vector([60,150], Object.values(size)), new Vector([69,230], Object.values(size))],
        // [new Vector([180,80], Object.values(size)), new Vector([189,160], Object.values(size))],
    ]

    const getBreedingAreas = () => [
        [
            new Vector([
                size.width - (size.width / 8),
                0
            ], Object.values(size)),
            new Vector([
                size.width,
                size.height
            ], Object.values(size)),
        ],
    ]

    const getSpawnAreas = () => [
        // [
        //     new Vector([0, 0], Object.values(size)),
        //     new Vector([size.width, size.height], Object.values(size)),
        // ],
        [
            new Vector([0, 30], Object.values(size)),
            new Vector([size.width / 8, 120], Object.values(size)),
        ],
        [
            new Vector([0, 150], Object.values(size)),
            new Vector([size.width / 8, 230], Object.values(size)),
        ]
    ]

    const letThereBeLight = () => {
        const spawnAreas = getSpawnAreas()
        const generateAgent = (neuronPool, genomeSize, world) => (parents = []) => {
            const agent = new Agent(
                new Vector([0,0], [world.size.width, world.size.height]),
                neuronPool,
                genomeSize,
                parents,
                function (agent) {
                    return Math.max(...world.breedingAreas.map(area => {
                        const middle = [...area[1].subtract(area[0])].map((el, idx) => ((el / 2) + area[0][idx]));
                        const distance = [agent.posVector[0] - middle[0], agent.posVector[1] - middle[1]];
                        const oldDistance = [agent.oldPosVector[0] - middle[0], agent.oldPosVector[1] - middle[1]];

                        const diffX = distance[0] - oldDistance[0];
                        const diffY = distance[1] - oldDistance[1];
                        return (diffX < 0 ? -1 : (diffX > 0 ? 1 : 0)) + (diffY < 0 ? -1 : (diffY > 0 ? 1 : 0));
                    }))
                }
            );
            agent.attach(world);
            return agent;
        }

        const populationFactory = (world, size = 2000) => {
            return new Population(
                world,
                size,
                generateAgent(
                    neuronPool(world),
                    4,
                    world
                )
            );
        }

        return new World(
            size,
            10000,
            16,
            getBreedingAreas(),
            spawnAreas,
            getWalls(),
            populationFactory
        )
    }

    let killSwitch = () => {};
    let generations = 0;
    const genMarker = document.getElementById('gen')
    const start = e => {
        const world = letThereBeLight();
        const run = () => {
            const renderer = new WorldRenderer(world);
            killSwitch = killEvt => {
                if (killEvt) {
                    world.kill();
                    generations = 0;
                    genMarker.textContent = generations;
                }
                renderer.clear();
                document.getElementById('play').removeEventListener('click', play)
                document.getElementById('pause').removeEventListener('click', pause)
                e.target.addEventListener('click', start)
            }
            renderer.attach(clickObserver)
            const play = () => world.play()
            const pause = () => world.pause()
            document.getElementById('play').addEventListener('click', play)
            document.getElementById('pause').addEventListener('click', pause)
            e.target.removeEventListener('click', start)
            renderer.render()
        }
        world.attach({
            update: (e) => {
                genMarker.textContent = ++generations;
                killSwitch();
                run();
            }
        })

        run()
    }


    document.getElementById('start').addEventListener('click', start)
    document.getElementById("killSw").addEventListener('click', (e) => {
        killSwitch(e)
    })

</script>
</body>
</html>